<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?gid=0&single=true&output=csv";

const parseNumber = v => {
  const s = (v||"").trim().replace(/\./g,'').replace(',', '.'); // 1.234,56 -> 1234.56
  const n = Number(s);
  return isNaN(n) ? null : n;
};

async function fetchCSV(url){
  const res = await fetch(url, {cache: "no-store"});
  const text = await res.text();
  // soporta filas con comas dentro de comillas
  const rows = text.split(/\r?\n/).map(line=>{
    const out=[]; let cur="", inQ=false;
    for (let i=0;i<line.length;i++){
      const c=line[i], n=line[i+1];
      if (c === '"' && n === '"'){ cur+='"'; i++; continue; }
      if (c === '"'){ inQ = !inQ; continue; }
      if (c === ',' && !inQ){ out.push(cur.trim()); cur=""; continue; }
      cur += c;
    }
    out.push(cur.trim());
    return out;
  });
  return rows;
}

function normalize(rows){
  const [head,...data] = rows.filter(r=>r.length>1);
  const idx = Object.fromEntries(head.map((h,i)=>[h.trim().toLowerCase(), i]));
  const pick = (r,k,alt=[]) => r[idx[k]] ?? alt.map(a=>r[idx[a]]).find(Boolean) ?? "";
  return data.map(r=>({
    ticker:        pick(r,'ticker'),
    empresa:       pick(r,'empresa'),
    ex_date:       pick(r,'ex_date'),
    pay_date:      pick(r,'pay_dat', ['pay_date','paydate']),
    importe_bruto: parseNumber(pick(r,'importe_bru', ['importe','importe_bruto'])),
    moneda:        pick(r,'moneda') || 'EUR',
    estado:        (pick(r,'estado')||'').toLowerCase(),
    fuente_url:    pick(r,'fuente_url')
  }));
}

function monthKey(iso){
  if (!iso) return 'Sin fecha';
  const d = new Date(iso);
  if (isNaN(d)) return iso;
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}

function render(items){
  const byMonth = new Map();
  for (const it of items){
    const k = monthKey(it.ex_date);
    if (!byMonth.has(k)) byMonth.set(k, []);
    byMonth.get(k).push(it);
  }

  const months = [...byMonth.keys()].sort();
  const $timeline = document.getElementById('timeline');
  $timeline.innerHTML = "";

  for (const m of months){
    const box = document.createElement('section');
    box.className = 'month';
    const title = m.includes('-') ? new Date(m+'-01').toLocaleString('es-ES',{year:'numeric',month:'long'}) : m;
    box.innerHTML = `<h3>${title}</h3>`;
    const ul = document.createElement('ul');

    byMonth.get(m).sort((a,b)=> (a.ex_date||'').localeCompare(b.ex_date));

    for (const it of byMonth.get(m)){
      const li = document.createElement('li');
      li.className = it.estado.includes('pend') ? 'pendiente' : 'confirmado';
      li.innerHTML = `
        <div class="row">
          <strong>${it.empresa || it.ticker}</strong>
          <span>Ex: ${it.ex_date || '-'}</span>
          <span>Pago: ${it.pay_date || '-'}</span>
          <span>${it.importe_bruto ?? '-'} ${it.moneda}</span>
          ${it.fuente_url ? `<a href="${it.fuente_url}" target="_blank" rel="noopener">Fuente</a>` : ``}
        </div>`;
      ul.appendChild(li);
    }
    box.appendChild(ul);
    $timeline.appendChild(box);
  }
}

(async ()=>{
  try{
    const rows = await fetchCSV(CSV_URL);
    const items = normalize(rows);
    render(items);
  }catch(e){
    console.error(e);
    document.getElementById('timeline').textContent = "No se pudo cargar el calendario.";
  }
})();
</script>

